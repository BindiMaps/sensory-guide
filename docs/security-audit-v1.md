# Security Audit Report v1

**Project:** Sensory Guide
**Date:** 2026-02-02
**Auditor:** Claude Opus 4.5 (Automated Security Review)
**Status:** ✅ PASS - Production Ready

---

## Executive Summary

This security audit evaluated the Sensory Guide application across seven categories: input validation, Firestore security rules, Storage security rules, file upload security, Cloud Functions authentication/authorisation, client-side security, and dependency vulnerabilities.

**Overall Assessment:** The application demonstrates a strong security posture with properly implemented authentication, authorisation, and input validation. No critical or high-severity vulnerabilities were identified in the application code.

---

## Audit Findings

### 1. Input Validation Audit

**Severity: ✅ No Issues Found**

#### 1.1 Text Input Fields Review

| Input | Location | Validation | Sanitisation | Assessment |
|-------|----------|------------|--------------|------------|
| Venue Name | CreateVenue.tsx | `trim()` required, max 100 chars (server) | None needed (text content) | ✅ Safe |
| URL Slug | CreateVenue.tsx | `slugify()` regex pattern | Alphanumeric + hyphens only | ✅ Safe |
| Editor Email | VenueDetail.tsx | Regex + duplicate check | `.toLowerCase().trim()` | ✅ Safe |
| Allow-list Email | AllowListManager.tsx | Regex + duplicate check | `.toLowerCase().trim()` | ✅ Safe |
| Embed URLs | EmbedEditor.tsx | Domain allowlist + HTTPS | `.trim()` | ✅ Safe |
| Search | AllVenuesList.tsx | None (filter only) | N/A - client-side only | ✅ Safe |

#### 1.2 Slug Validation Pattern

The `slugify()` function (CreateVenue.tsx:17-24, createVenue.ts:17-24) properly sanitises slugs:
```typescript
.toLowerCase()
.trim()
.replace(/[^\w\s-]/g, '')    // Remove special chars
.replace(/[\s_-]+/g, '-')     // Normalise to hyphens
.replace(/^-+|-+$/g, '')      // Trim leading/trailing
```

**Verdict:** Only alphanumeric characters and hyphens pass through. No injection risk.

#### 1.3 XSS Prevention

- **Zero instances of `dangerouslySetInnerHTML`** in production code
- All user content rendered via React's automatic escaping (`{variable}`)
- Error messages rendered as text, not HTML
- No HTML template literals with user data

#### 1.4 Server-Side Validation

| Function | Validation | Assessment |
|----------|------------|------------|
| `createVenue` | Name required, max 100 chars, slug required | ✅ |
| `transformPdf` | venueId, uploadPath, logId required as strings | ✅ |
| `publishGuide` | venueId, outputPath required as strings | ✅ |
| `addToAllowList` | Email regex validation | ✅ |

---

### 2. Firestore Security Rules Audit

**Severity: ✅ No Issues Found**

#### 2.1 Default Deny

```
match /{document=**} {
  allow read, write: if false;
}
```
✅ All unknown paths are denied by default.

#### 2.2 Venues Collection

| Operation | Rule | Assessment |
|-----------|------|------------|
| Read | Published OR editor OR superAdmin | ✅ Properly scoped |
| Create | `false` (via Cloud Function only) | ✅ Server-enforced allow-list |
| Update | Editor AND hasAtLeastOneEditor | ✅ Prevents self-lockout |
| Delete | Editor AND only one editor left | ✅ Safe cascade |

**Editor Access Function:**
```
function isEditor(venueData) {
  return request.auth != null &&
         request.auth.token.email in venueData.editors;
}
```
✅ Properly checks authentication and membership.

#### 2.3 Super Admin Implementation

- Primary: Reads from `config/superAdmins.emails[]` array
- Fallback: Hardcoded `['keith@bindimaps.com']` (sync check)
- Both normalise email to lowercase for comparison
- ✅ Minimal attack surface - config document is write-protected

#### 2.4 Config Documents

```
match /config/{docId} {
  allow read: if request.auth != null;
  allow write: if false;
}
```
✅ Read-only for authenticated users, no client writes.

#### 2.5 LLM Logs & Usage Tracking

```
match /llmLogs/{logId} {
  allow read: if request.auth.token.email == resource.data.userEmail;
  allow write: if false;  // Functions only
}

match /usage/{userEmail}/daily/{date} {
  allow read: if request.auth.token.email == userEmail;
  allow write: if false;  // Functions only
}
```
✅ User-scoped reads, server-only writes.

---

### 3. Storage Security Rules Audit

**Severity: ✅ No Issues Found**

#### 3.1 Public Read Scope

| Path | Access | Assessment |
|------|--------|------------|
| `/venues/{id}/versions/*` | Public read | ✅ Published guides (intentional) |
| `/public/guides/*` | Public read | ✅ Slug-based public access |
| `/venues/{id}/*` | Auth read, no write | ✅ Signed URLs for upload |
| Default | Deny all | ✅ |

#### 3.2 Write Protection

All write operations are denied at the rules level:
```
allow write: if false;
```
Uploads occur via signed URLs generated by Cloud Functions with:
- 15-minute expiry
- Content-Type locked to `application/pdf`

#### 3.3 Path Traversal

Storage rules use wildcard segments (`{venueId}`, `{filename}`) which Firebase validates as single path components. No path traversal possible via `../` or similar.

---

### 4. File Upload Security

**Severity: ✅ No Issues Found**

#### 4.1 Upload Flow (getSignedUploadUrl.ts)

1. **Authentication:** `requireAuth()` verifies user
2. **Authorisation:** `requireEditorAccess()` verifies venue access
3. **Rate Limiting:** `checkRateLimit()` enforces daily caps
4. **Signed URL:** Content-Type locked to `application/pdf`

#### 4.2 Content-Type Enforcement

```typescript
const [url] = await file.getSignedUrl({
  action: 'write',
  expires: Date.now() + 15 * 60 * 1000,
  contentType: 'application/pdf',  // Enforced server-side
})
```
✅ Server-side MIME type validation via signed URL constraints.

#### 4.3 File Size

- Client-side: 10MB limit in `uploadSchema.ts`
- Server-side: Implicit via Cloud Storage quotas and function timeouts

**Recommendation (Low):** Consider adding explicit server-side file size validation in `transformPdf` before PDF parsing.

---

### 5. Cloud Functions Auth/Authz Review

**Severity: ✅ No Issues Found**

#### 5.1 Authentication Coverage

| Function | `requireAuth()` | `requireEditorAccess()` | Super Admin Check |
|----------|-----------------|------------------------|-------------------|
| createVenue | ✅ | N/A | `isApprovedUser()` |
| getSignedUploadUrl | ✅ | ✅ | N/A |
| transformPdf | ✅ | ✅ | Rate limit bypass |
| publishGuide | ✅ | ✅ | N/A |
| listVersions | ✅ | ✅ | N/A |
| setLiveVersion | ✅ | ✅ | N/A |
| deleteVersion | ✅ | ✅ | N/A |
| getAllVenues | ✅ | N/A | Required |
| getAllowList | ✅ | N/A | Required |
| addToAllowList | ✅ | N/A | Required |
| removeFromAllowList | ✅ | N/A | Required |

✅ All functions properly authenticated.

#### 5.2 Input Validation

All functions validate inputs with explicit type checks:
```typescript
if (!venueId || typeof venueId !== 'string') {
  throw new HttpsError('invalid-argument', 'venueId is required')
}
```

**Note:** Functions use manual TypeScript checks rather than Zod. This is acceptable as the data structures are simple (strings, arrays).

#### 5.3 Rate Limiting

- Location: `rateLimiter.ts`
- Limit: 20 transforms per user per day
- Bypass: Super admins only
- Counter: Firestore `/usage/{email}/daily/{date}`

✅ Properly implemented with user scope.

#### 5.4 Error Message Review

| Function | Error Example | Leaks Internals? |
|----------|--------------|------------------|
| requireAuth | "Must be logged in" | No |
| requireEditorAccess | "Not an editor of this venue" | No |
| createVenue | "Account not yet approved" | No |
| transformPdf | "Could not parse PDF" | No (generic) |

✅ No stack traces, internal paths, or sensitive data in error messages.

#### 5.5 Audit Logging

LLM operations logged to `/llmLogs/{logId}`:
- `userEmail` ✅
- `venueId` ✅
- `uploadPath` ✅
- `status` ✅
- `tokensUsed` ✅
- `createdAt` (serverTimestamp) ✅

✅ Sufficient audit trail for LLM usage.

---

### 6. Client-Side Security Audit

**Severity: ✅ No Issues Found**

#### 6.1 localStorage Usage

| Store | Key | Contents | Assessment |
|-------|-----|----------|------------|
| guideStore | `sensory-guide-sections` | Expanded section IDs only | ✅ No sensitive data |

✅ Only UI preferences stored.

#### 6.2 Bundle Contents

**Firebase Config:**
```typescript
const firebaseConfig = {
  apiKey: 'AIzaSy...',           // Public by design
  authDomain: '...',
  projectId: 'sensory-guide',
  storageBucket: '...',
  measurementId: '...',
}
```
✅ Firebase web config is designed to be public. Security enforced via rules.

**Environment Variables:**
- `VITE_USE_EMULATORS` - dev flag only
- `VITE_FIREBASE_MEASUREMENT_ID` - public GA ID

✅ No secrets in client bundle.

#### 6.3 Hardcoded Credentials Search

Searched for patterns: `apiKey`, `secret`, `password`, `token`, `credential`
- Only Firebase public config found
- No API keys for external services
- No hardcoded passwords

✅ Clean.

---

### 7. Dependency Security Audit

**Severity: ⚠️ Low (Acceptable)**

#### 7.1 yarn audit Results

```
┌───────────────┬──────────────────────────────────────────────────────┐
│ high          │ semver vulnerable to ReDoS                          │
├───────────────┼──────────────────────────────────────────────────────┤
│ Package       │ semver                                               │
│ Patched in    │ >=7.5.2                                              │
│ Dependency of │ pa11y-ci                                             │
│ Path          │ pa11y-ci > pa11y > semver                            │
└───────────────┴──────────────────────────────────────────────────────┘
1 vulnerabilities found
```

#### 7.2 Assessment

| Vulnerability | Package | Severity | Runtime Impact | Decision |
|---------------|---------|----------|----------------|----------|
| ReDoS in semver | pa11y-ci > semver | High | Dev dependency only | ⚠️ Accept (not in production bundle) |

**Rationale:** pa11y-ci is a development/CI tool, not bundled in the application. The vulnerable semver package is only executed during CI accessibility tests, not by end users.

#### 7.3 CI Integration

CI job `security-audit` runs `yarn audit --level high` with warning on failure:
```yaml
run: yarn audit --level high || echo "::warning::Vulnerabilities found"
```
✅ Monitoring in place.

---

## Recommendations

### Low Priority

1. **Explicit file size validation in transformPdf**
   - Current: Implicit via Cloud Storage/function limits
   - Recommended: Add explicit check before PDF parsing

2. **Update pa11y-ci when patch available**
   - Track upstream for semver update
   - Low urgency (dev dependency only)

3. **Consider Zod for function input validation**
   - Current TypeScript checks are sufficient
   - Zod would provide runtime schema validation for complex inputs

---

## Sign-Off Statement

Based on this comprehensive security audit, the Sensory Guide application is **approved for production deployment**.

The application demonstrates:
- ✅ Proper authentication on all protected endpoints
- ✅ Correct authorisation (editor scoping, super admin controls)
- ✅ Input validation preventing XSS and injection attacks
- ✅ Secure file upload via signed URLs with type constraints
- ✅ Rate limiting to prevent abuse
- ✅ Audit logging for compliance
- ✅ No sensitive data in client storage or bundle
- ✅ No critical/high vulnerabilities in production dependencies

**Signed:** Claude Opus 4.5 (Automated Security Review)
**Date:** 2026-02-02
